<!-- 今日の日付（固定ヘッダー） -->
<div class="sticky top-0 z-50 bg-white/90 backdrop-blur border-b px-4 py-2">
  <strong><%= l @today, format: :long %></strong>
</div>

<div class="max-w-3xl mx-auto p-4 space-y-6">
  <h1 class="text-xl font-bold">ファスティング</h1>

  <% if @running.present? %>
    <!-- 進行中 -->
    <div class="rounded-lg border p-4 space-y-2">
      <p>開始: <%= l @running.start_time %></p>
      <p>
        経過:
        <span data-controller="timer"
              data-timer-start-at-value="<%= @running.start_time.to_i %>"
              class="font-mono">
          0
        </span> 秒
      </p>
      <div class="flex gap-2">
        <%= button_to "終了（達成）",
              finish_fasting_record_path(@running, success: true),
              method: :post,
              class: "px-3 py-2 rounded bg-emerald-600 text-white" %>
        <%= button_to "終了（失敗）",
              finish_fasting_record_path(@running, success: false),
              method: :post,
              class: "px-3 py-2 rounded bg-rose-600 text-white" %>
      </div>
    </div>
  <% else %>
    <!-- 未開始：目標時間→開始 -->
    <div class="rounded-lg border p-4">
      <%= form_with url: start_fasting_records_path, method: :post, local: true, class: "flex items-center gap-3" do %>
        <%= select_tag :target_hours,
              options_for_select(FastingRecord::TARGET_HOURS_CHOICES.map { |h| ["#{h}時間", h] }),
              include_blank: "目標時間を選択（必須）",
              required: true,
              class: "border rounded px-2 py-1" %>
        <%= submit_tag "開始", class: "px-3 py-2 rounded bg-blue-600 text-white" %>
      <% end %>
    </div>
  <% end %>

  <hr>

  <h2 class="font-semibold">最近の記録</h2>
  <table class="min-w-full border text-sm">
    <thead class="bg-gray-50">
      <tr>
        <th class="px-3 py-2 text-left">開始</th>
        <th class="px-3 py-2 text-left">終了</th>
        <th class="px-3 py-2 text-center">目標(h)</th>
        <th class="px-3 py-2 text-left">結果</th>
        <th class="px-3 py-2 text-left"></th>
      </tr>
    </thead>
    <tbody>
      <% @records.each do |r| %>
        <tr class="border-t">
          <td class="px-3 py-2"><%= l r.start_time %></td>
          <td class="px-3 py-2"><%= r.end_time ? l(r.end_time) : "-" %></td>
          <td class="px-3 py-2 text-center"><%= r.target_hours || "-" %></td>
          <td class="px-3 py-2"><%= r.success.nil? ? "-" : (r.success ? "達成" : "失敗") %></td>
          <td class="px-3 py-2">
            <%= link_to "詳細", r, class: "text-blue-600 underline" %> /
            <%= link_to "編集", edit_fasting_record_path(r), class: "text-blue-600 underline" %>
          </td>
        </tr>
      <% end %>
    </tbody>
  </table>
</div>
