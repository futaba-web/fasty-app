# Fasty（ファスティング × 瞑想の習慣化アプリ）

> **キャッチコピー**：**「身体を整えるだけじゃなく、心も整えるファスティング」**  

※ 本READMEは卒業制作アプリの **最終版（リリース時点）** の内容です。  
MVPからの拡張として、PWA化 / Googleログイン / LINEログイン / カレンダー表示 / 独自ドメイン対応 / AI食事コンシェルジュ機能 などを追加しています。

---

## 画面遷移図

Figma : <https://www.figma.com/design/ScFMOAr4EFUWSO7vvssFmx/%E7%84%A1%E9%A1%8C?node-id=550-282&t=GwqbJSDHrEE3CbxX-1>  
（公開設定：リンクを知っている全員 / 閲覧）

---

## ER図

draw.io（ER図）: <https://drive.google.com/file/d/1bSqFGu3fWilWBu2lvpHGrll2frx6C8FW/view?usp=sharing>

---

## サービス概要（3行）

- ファスティングと**瞑想/呼吸**を組み合わせ、空腹の波・ストレスを“やり過ごす力”を育てる習慣化アプリ。  
- 断食は **開始/終了の2タップ＋保存時の自動判定**、瞑想は**短時間ガイドへのワンタップ導線**で摩擦を最小化。  
- リリース版では、ファスティング状況に応じて1日の食事メニューを提案する **「AI食事コンシェルジュ」** を搭載し、回復期の不安もサポート。

---

## 用語について

- 本アプリで扱うファスティングは、**時間制限食（Time-Restricted Eating / IF）** を想定しています。
  - 「いつ食べるか」の時間窓を管理するものであり、医療上の絶食（NPO）や長期の完全断食は対象外です。

- 本プロダクトの立場（推奨ポリシー）
  - Fasty はウェルネス文脈における「無理のない時間窓の管理」を推奨します（例：12–14時間から始める）。
  - 効果・安全性は体調や既往歴、服薬状況などで異なるため、**医療的判断や個別指示は一切行いません**。
  - 体験設計は **入力の摩擦最小化** と **ポジティブな継続支援**（達成/未達時のメッセージ、終了時コメント、AIによる優しい提案）に重点を置いています。

---

## このサービスへの思い・作りたい理由

- 忙しさやストレスで「空腹の波」に飲まれ、ファスティングを継続できない人が多い。  
  入力や達成判定の手間も負担になりがちです。
- そこで、
  - 記録は **開始/終了/コメント** に絞り、達成判定はアプリ側で自動化。
  - 気分のケアは **短い瞑想ガイド**と**やさしい文言のフラッシュメッセージ**で支える。
- うまくいかない日も「ダメだった日」で終わらせず、**自己効力感を下げないメッセージ**とUIで翌日に橋をかけることを目指しています。
- リリース版ではさらに、断食後に多い「何を食べたらいいか分からない」という悩みを解消するため、  
  **AI食事コンシェルジュ機能**を追加し、回復期の不安も含めて一気通貫でサポートするようにしました。

---

## 個人的な原体験と気づき

- 日常的に16時間ファスティングを取り入れつつ、最長10日間のファスティングにも挑戦（ビタミン等を含む飲料のみ）。  
- ダイエット目的というよりデトックスの実験として行い、結果的に **5kg減** の副次効果がありました。
- 体重以外の変化（体調の安定、睡眠の質向上、肌荒れの改善、食べ物への感謝の変化など）が大きく、  
  「食との向き合い方」が変わった体験をしました。
- 一方で、**空腹の波やストレスに折れそうになるタイミング**が必ずあり、瞑想や呼吸法が非常に有効だと実感しました。
- これらの体験から、
  - 断食と瞑想は相性が良いこと、
  - 「入力の摩擦が少なく」「すぐ使える瞑想導線」があると継続しやすいこと、
  - そして断食後の食事内容を迷わないこと  
  が習慣化の鍵だと感じ、本サービスを企画・実装しました。

---

## ユーザー層（ペルソナ）

- **忙しくてストレスが多い社会人**
  - 短時間で気持ちをリセット（3〜10分の呼吸/瞑想）。  
- **睡眠の質を上げたい人**
  - 夜の軽い瞑想とファスティングでリズムを整えたい。  
- **マインドフルネス/瞑想に興味がある人**
  - まずは「ワンタップで始められる」形で試したい。  
- **“ダイエットだけじゃない”人**
  - 体重だけでなく、**気分の記録・ストリーク・AIのやさしい提案**で継続モチベを維持したい。

---

## サービスの利用イメージ

1. 目標（12/14/16/18/20/22/24h）を選んで **ファスティング開始**。  
2. ファスティング中に空腹の波や集中力の低下を感じたら、**瞑想ページから短尺ガイドへワンタップ**。  
3. **終了** → 保存で **達成/未達が自動判定**。その時の気持ちを一言コメント。  
4. マイページや **カレンダー画面** でストリークや週/月の傾向を確認。  
5. 断食明けや回復期には、**AI食事コンシェルジュ**でその日の食事メニューを提案してもらう。

---

## 差別化ポイント（MVP + リリース版）

- **“摩擦ゼロ”の断食記録**
  - ワンタップ開始/終了＋**保存時の自動判定（秒精度・30s猶予）**。
  - 編集時に既存 `end_time` を安易に上書きしない安全設計。
- **メンタル介入の同梱**
  - 断食中に**短尺の瞑想/呼吸ガイド**へすぐアクセス。
- **ポジティブ・フラッシュ + 終了時コメント**
  - 達成時は称賛、未達時は「ここまで頑張れた」ことを労い、次への一歩を後押し。
- **ファスティングカレンダー + ストリーク表示**
  - カレンダー上で過去の断食記録を色分け表示し、**連続達成日数**を可視化。
- **AI食事コンシェルジュ（NEW）**
  - 直近1週間のファスティング状況から、**その人に合わせた1日の食事メニュー**をAIが提案。  
  - 「頑張りすぎている人には優しいメニュー」「継続できている人には前向きな提案」など、  
    状態に応じた“やさしい回復食プラン”を自動生成。  
  - 極端な食事制限や医療的アドバイスはプロンプト側で禁止し、安全性に配慮。
- **PWA対応**
  - スマホのホーム画面に追加して**アプリのように起動**。  
  - サービスワーカーによるキャッシュで、主要画面はネットワーク不安定時も表示しやすい。
- **マルチログイン**
  - メールアドレス + パスワードに加え、**Googleログイン・LINEログイン**に対応。  
  - LINE連携は、将来的な**完了通知/リマインド通知**の基盤としても設計。
- **レスポンシブ対応 & 使い方ページ**
  - スマホ中心の利用を想定しつつ、PCでも見やすいレイアウトに調整。  
  - 初めての人でも迷わないよう、スクリーンショット付きの「使い方」ページを用意。
- **独自ドメイン + 本番運用を意識した構成**
  - Render へのデプロイに加え、独自ドメイン + canonical host でURLを統一。  
  - 本番/開発で設定を分け、環境変数ベースで安全に管理。

---

## MVPの本質とスコープ（履歴として）

**本質**：ファスティングの継続率を上げる **摩擦最小＋前向きリスタート**  

- 入力・判断の負荷を最小化（ワンタップ開始/終了、保存時の自動判定）  
- 未達でも閉じない体験（結果別ポジティブ・フラッシュ、ストリークで小さな成功を可視化）

**MVP（必須）**

- ファスティング：開始/終了、**保存時自動判定（秒精度・30s猶予）**、**終了時コメント（1行）**  
- 画面：一覧/詳細/編集、**結果別ポジティブ・フラッシュ**  
- 指標：**ストリーク（ファスティング）**

**MVP（任意・軽量）**

- 瞑想ガイド：**外部リンク一覧（YouTube）**のみ（埋め込み/自前音声は後続）

---

## リリース版で追加した主な機能

- AI食事コンシェルジュ機能（後述）
- 週/月の統計の整備
- ファスティングカレンダー（色分け/バッジ表示）
- PWA対応（manifest + service worker）
- Googleログイン / LINEログイン（OmniAuth）
- LINE通知ON/OFFの設定（将来のリマインド機能用）
- レスポンシブデザインの強化（スマホファースト）
- 使い方説明ページ（オンボーディング）
- 独自ドメイン + canonical host 対応

---

## AI食事コンシェルジュ機能（技術的な概要）

### 1. 断食状況の解析サービス：`FastingInsight`

- `app/services/fasting_insight.rb` で、直近7日間のファスティング記録を解析。
- 主に以下の指標を算出：
  - 合計/平均ファスティング時間  
  - 継続率・目標達成率（target_hours に対して 80〜90% 以上を成功と判定）  
  - 現在断食中かどうか（`end_time` が `nil`）  
  - 最後の断食終了からの日数  
  - 直近の目標時間・連続成功日数（ストリーク） など
- このロジックをサービスクラスに切り出すことで、**コントローラの責務を絞りつつテストしやすい構成**に。

### 2. AIプロンプト生成：`AI::MealPlanner`（イメージ）

- `FastingInsight` の結果を元に、OpenAI API（gpt-5系）へ渡すプロンプトを組み立て。
- 必ず **JSON形式** で以下の構造を返すように指示：
  - 朝 / 昼 / 夜  
    - `menu`：メニュー  
    - `why`：このメニューを提案する理由  
    - `note`：補足・注意点  
  - `alerts`：1日全体に対する注意点
- プロンプト上の工夫：
  - **消化に優しい和食中心**であること  
  - 極端な食事制限や医療的アドバイスは **禁止**  
  - 同じユーザーでも再生成時には内容を少し変える（バリエーション）
- レスポンスはJSONパースし、**パースエラー/タイムアウト時はアプリを落とさず**  
  「メニューを生成できませんでした」とフラッシュ表示するだけに留める。

### 3. 提案結果の保存：`MealSuggestion` モデル

- `MealSuggestion` テーブル：
  - `user_id`（外部キー）
  - `target_date`（日付）  
  - `phase`（`"insight_based"` など）
  - `content`（AI返却JSONを保存する `jsonb` カラム）
- `user_id + target_date` にユニーク制約を付与し、  
  **1ユーザー・1日1件**になるようDBレベルで担保。
- 「今日の提案を作る」「もう一案もらう」ボタンはいずれもこのレコードを更新する形で実装。

### 4. コントローラと画面：`MealSuggestionsController`

- `show`：
  - 今日の `MealSuggestion` があれば表示。
  - なければ「まだ今日の食事提案は作成されていません。」と案内。
- `create`：
  - `FastingInsight` → `AI::MealPlanner` → `MealSuggestion` 保存までを一連の処理として実行。
  - どこかで失敗した場合、保存せずフラッシュメッセージのみ表示。
- 画面（`/meal_suggestion`）：
  - 朝 / 昼 / 夜をカード形式で表示し、`menu` / `why` / `note` を読みやすくレイアウト。
  - 画面上部に栄養士のアイコンと「AI食事コンシェルジュ」のタイトルを表示。
  - 「医療行為ではありません」注意書きを常設。
  - スマホ時も読みやすいようにフォント・余白・改行を調整。

---

## ユーザー獲得の方針（概要）

- ペルソナ：忙しい社会人／睡眠の質を上げたい人／マインドフルネス・瞑想に関心がある人。
- ターゲットキーワード：
  - 断食の実務：「ファスティング 記録」「断食 タイマー」「16時間断食 継続」など。
  - メンタル寄り：「瞑想 ガイド 初心者」「寝る前 瞑想 音声」など。
- チャネル：
  - note / ブログでの体験シェア記事
  - X での成果報告・日々の記録シェア
  - コミュニティ（プログラミングスクール・ヘルスケア系コミュニティ）でのβ配布
- KPI：
  - 登録数、初回開始率、D1/D7継続率、AI食事コンシェルジュ利用率 など。

---

## 使用技術 / 構成

- **バックエンド**
  - Ruby 3.2.2
  - Rails 8.x（Hotwire / Turbo / Stimulus / Importmap）
  - MySQL 8.0
- **フロントエンド**
  - Tailwind CSS
  - Stimulus（タイマー・UI制御・チャート表示など）
- **インフラ / デプロイ**
  - Docker / Docker Compose
  - Render（Webサービス + MySQL）
  - 独自ドメイン + canonical host ミドルウェア
- **認証 / 外部連携**
  - Devise
  - OmniAuth（Google OAuth2 / LINE Login）
  - LINE Messaging API（将来の完了通知・リマインド通知に利用予定）
  - OpenAI API（gpt-5 系 / JSONモード）
- **その他**
  - PWA（manifest.json / service worker）
  - RSpec（モデル・リクエスト・システムテスト）
  - RuboCop（コーディング規約チェック）

---

## 健康と安全について（重要）

ファスティングや食事制限は体調や既往歴、服薬状況によって**リスクが生じる**ことがあります。  
実施の可否は、必ず医師など **医療専門職に相談** した上で判断してください。  
本アプリは医療行為や指示を提供するものではありません。

### 想定されるデメリット / 副作用の例

- 空腹感、倦怠感、頭痛、いら立ち、集中力低下、便秘、睡眠の質の低下 など。  
  多くは一過性ですが、症状が続く・強い場合は中止してください。
- 糖尿病などの持病がある方、低血糖を起こしやすい方、服薬に食事が必須の方は、  
  低血糖・電解質異常などのリスクに注意が必要です。
- 長時間ファスティングを慢性的に繰り返す、急速な減量を行うなど、  
  極端な実践は胆石や体調悪化のリスクがあります。
- 高齢者や低栄養が疑われる状態では、体力低下や転倒リスクに留意が必要です。

### 実施を避ける / 医師に必ず相談すべきケースの例

- 妊娠中 / 授乳中
- 18歳未満
- 摂食障害の既往や現在の症状がある方
- 糖尿病・心疾患・腎疾患などの慢性疾患がある方
- 服薬に食事が必須の方 など

### 中止・受診を検討すべきサイン

- 強いめまい・失神しそうな感覚、胸痛・動悸
- 嘔吐や下痢が続く、著しい脱水や混乱 など

> **免責事項**：本アプリは健康や疾病の診断・治療・予防を目的としたものではありません。  
> 記載内容は一般情報であり、医療アドバイスではありません。体調不良時は直ちに中止し、医療機関に相談してください。

---

## 健康と安全の伝え方（アプリ内実装）

- **必読モーダル（初回/改訂時）**
  - 要点3つを簡潔に表示し、チェックボックスに同意しないと「開始」できない仕様。
  - 保存するのは `accepted_health_notice_at` / `health_notice_version` のみ（個人の健康情報は保持しない）。

- **長時間目標の注意**
  - 目標が 18h 以上の開始時には、追加の注意文（「水分・電解質の補給」「体調不良時は中止」など）を表示。
  - 24h 以上は警告色で強調表示。

- **恒常的な入口**
  - フッターに「健康と安全」ページへのリンクを配置。

- **同意の更新**
  - 文面を改訂した場合はバージョンを比較し、再同意を求める。

---

## 補足・権利

- 瞑想は外部リンクのみを提供し、音源自体の再配布は行わない方針です。
- 食事提案はAIによる一般的な提案であり、栄養指導や医療行為ではありません。

